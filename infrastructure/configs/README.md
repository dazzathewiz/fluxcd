# Infrastructure Configs

## 1Password provider using External Secrets Operator
See: [1Password Connect](../doc-1password)

## Notify and Alerts `notify-slack.yaml`
- A slack URL is configured in 1Password `fluxcd-slackurl`
- The URL secret `fluxcd-slackurl` syncronised from 1Password
- A `slack` provider type is configured
- `on-call-webapp` Alert is configured with default settings

### Sources
[Flux Guide][https://fluxcd.io/flux/guides/notifications/]
[TechnoTim Guide][https://docs.technotim.live/posts/flux-devops-gitops/]

## Traefik & Cert-Manager

ðŸ“º [Watch the TechnoTim Video](https://www.youtube.com/watch?v=G4CmbYL9UPg)
ðŸ“º [Watch Chistian Lempa's Video](https://www.youtube.com/watch?v=DvXkD0f-lhY)

### [Traefik Dashboard](https://traefik.inf.dazzathewiz.com/)

- A Base64 encoded BasicAuth string is imported via 1Password to `traefik-dashboard-auth`
    Note this is generated by htpasswd `htpasswd -nb <user> <password> | openssl base64`
- `traefik.inf.dazzathewiz.com` is a DNS resolvable name pointing to the trafik Controller `loadBalancerIP`. This can be setup in PiHole via a [custom dnsmasq file](https://brandonrozek.com/blog/wildcarddomainspihole/)
- AWS Route53 AuthID and SecretKey is stored in 1Password as they are both sensitive (including the AuthID). `ClusterIssuers` can be configured with `accessKeyIDSecretRef` and `secretAccessKeySecretRef` respectively.
- Yaml deployment files used in the Traefik and Cert-Manager deployments [traefik cert-manager let's encrypt](https://github.com/techno-tim/launchpad/tree/master/kubernetes/traefik-cert-manager)
- Cert-Manager pods specifically reach out to external DNS using `values:` to solve problems when internal split-dns is available w/ different IP resolution to the internet DNS:
    ```
    extraArgs:
    - --dns01-recursive-nameservers=1.1.1.1:53,9.9.9.9:53
    - --dns01-recursive-nameservers-only
    podDnsPolicy: None
    podDnsConfig:
    nameservers:
        - 1.1.1.1
        - 9.9.9.9
    ```
- Useful commands to inspect certificates:
    - `kubectl get certificate --all-namespaces`
    - `kubectl describe certificate --all-namespaces`
    - `kubectl get challenges --all-namespaces ` -> will only show challenges currently in progress of being validated.

### Sources
[FluxCD example of cert-manager helm release][https://geek-cookbook.funkypenguin.co.nz/kubernetes/ssl-certificates/cert-manager/]
[Cert-Manager ClusterIssuer manifests][https://docs.gitops.weave.works/docs/guides/cert-manager/]
[Certificate Generation](https://geek-cookbook.funkypenguin.co.nz/kubernetes/ssl-certificates/wildcard-certificate/)
[Traefik Cookbook](https://geek-cookbook.funkypenguin.co.nz/kubernetes/ingress/traefik/)

## Rancher

ðŸ“º [Watch the TechnoTim Video](https://www.youtube.com/watch?v=APsZJbnluXg)

### [Rancher Dashboard](https://rancher.inf.dazzathewiz.com/)

## Longhorn

[Longhorn UI with Traefik](https://tansanrao.com/guide-storage-ingress-webui-k8s/)
[Longhorn defaul disk labelling](https://longhorn.io/kb/tip-only-use-storage-on-a-set-of-nodes/#tell-longhorn-to-create-a-default-disk-on-a-specific-set-of-nodes)
[Configuring Defaults for Nodes and Disks](https://longhorn.io/docs/1.4.1/advanced-resources/default-disk-and-node-config/)

### Requirements
- Have emberstack/reflector installed to sync `cert-manager` [secrets across namespaces](https://cert-manager.io/docs/tutorials/syncing-secrets-across-namespaces/)
- Configure a `Certificate` secret and ensure it's synced to the `cattle-system` namespace
- Include the `hostname:` as a subdomain of the traefik Controller loadBalancerIP
